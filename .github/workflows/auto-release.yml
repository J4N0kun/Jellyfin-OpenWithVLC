name: ğŸš€ Auto Release Complete

# Ce workflow fait TOUT automatiquement :
# 1. Build du plugin
# 2. CrÃ©ation de la release GitHub
# 3. Mise Ã  jour du manifest.json
# 4. DÃ©ploiement sur GitHub Pages

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (ex: 1.1.0)'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  complete-release:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    # ============================================
    # Ã‰TAPE 1 : CHECKOUT & VALIDATION
    # ============================================
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: ğŸ“‹ DÃ©tection de la version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=$(jq -r '.Version' plugin.json)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version dÃ©tectÃ©e: $VERSION"
        
    - name: ğŸ” Validation
      run: |
        echo "Validation des fichiers..."
        jq empty plugin.json || { echo "âŒ plugin.json invalide"; exit 1; }
        jq empty repository/manifest.json || { echo "âŒ manifest.json invalide"; exit 1; }
        node -c web/js/vlcMenu.js || { echo "âŒ vlcMenu.js invalide"; exit 1; }
        echo "âœ… Tous les fichiers sont valides"
    
    # ============================================
    # Ã‰TAPE 2 : BUILD DU PLUGIN
    # ============================================
    - name: ğŸ”¨ Build du plugin
      run: |
        chmod +x build.sh
        ./build.sh
        echo "ğŸ“¦ Build terminÃ©"
        ls -lh dist/
        
    - name: ğŸ” Calcul des checksums
      id: checksums
      run: |
        ZIP_CHECKSUM=$(sha256sum dist/Jellyfin-OpenWithVLC-v${{ steps.version.outputs.version }}.zip | cut -d' ' -f1)
        echo "checksum=$ZIP_CHECKSUM" >> $GITHUB_OUTPUT
        echo "ğŸ” SHA256: $ZIP_CHECKSUM"
    
    # ============================================
    # Ã‰TAPE 3 : EXTRACTION DU CHANGELOG
    # ============================================
    - name: ğŸ“ Extraction du changelog
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        if [ -f CHANGELOG.md ]; then
          # Extraire la section du changelog
          NOTES=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d' || echo "")
          
          if [ -z "$NOTES" ]; then
            NOTES="Version $VERSION - Voir CHANGELOG.md pour les dÃ©tails"
          fi
        else
          NOTES="Version $VERSION"
        fi
        
        # Sauvegarder dans un fichier pour Ã©viter les problÃ¨mes de multiline
        echo "$NOTES" > /tmp/release_notes.txt
        echo "ğŸ“ Changelog extrait"
    
    # ============================================
    # Ã‰TAPE 4 : CRÃ‰ATION DE LA RELEASE GITHUB
    # ============================================
    - name: ğŸš€ CrÃ©ation de la release GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
        body_path: /tmp/release_notes.txt
        files: |
          dist/*.zip
          dist/*.sha256
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ============================================
    # Ã‰TAPE 5 : MISE Ã€ JOUR DU MANIFEST.JSON
    # ============================================
    - name: ğŸ“ Mise Ã  jour du manifest.json
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        CHECKSUM="${{ steps.checksums.outputs.checksum }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "Mise Ã  jour du manifest avec:"
        echo "  Version: $VERSION"
        echo "  Checksum: $CHECKSUM"
        echo "  Timestamp: $TIMESTAMP"
        
        # Extraire le changelog pour cette version
        if [ -f CHANGELOG.md ]; then
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' | grep '^-' | sed 's/^- //' | tr '\n' '\\n' || echo "Version $VERSION")
        else
          CHANGELOG="Version $VERSION"
        fi
        
        # Mettre Ã  jour le manifest
        cd repository
        
        jq --arg version "$VERSION" \
           --arg checksum "$CHECKSUM" \
           --arg timestamp "$TIMESTAMP" \
           --arg changelog "$CHANGELOG" \
           --arg url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Jellyfin-OpenWithVLC-v$VERSION.zip" \
           --arg sourceUrl "https://github.com/${{ github.repository }}/archive/refs/tags/v$VERSION.tar.gz" \
           '.[0].versions = [
              {
                "version": $version,
                "changelog": $changelog,
                "targetAbi": "10.11.1.0",
                "sourceUrl": $sourceUrl,
                "checksum": $checksum,
                "timestamp": $timestamp,
                "artifacts": [
                  {
                    "filename": ("Jellyfin-OpenWithVLC-v" + $version + ".zip"),
                    "url": $url,
                    "checksum": $checksum
                  }
                ]
              }
            ] + (.[0].versions // [])' manifest.json > manifest.json.tmp
        
        mv manifest.json.tmp manifest.json
        
        echo "âœ… Manifest mis Ã  jour"
        jq '.[0].versions[0]' manifest.json
        
    - name: ğŸ“¤ Commit du manifest mis Ã  jour
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add repository/manifest.json
        git diff --staged --quiet || git commit -m "chore: auto-update manifest for v${{ steps.version.outputs.version }}"
        git push || echo "Rien Ã  pousser"
    
    # ============================================
    # Ã‰TAPE 6 : DÃ‰PLOIEMENT GITHUB PAGES
    # ============================================
    - name: ğŸŒ PrÃ©paration du site GitHub Pages
      run: |
        mkdir -p _site/repository
        cp repository/manifest.json _site/repository/
        cp repository/README.md _site/repository/
        
        # CrÃ©er la page d'accueil
        cat > _site/index.html <<'HTMLEOF'
        <!DOCTYPE html>
        <html lang="fr">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Jellyfin Plugin Repository - Open With VLC</title>
          <style>
            body {
              font-family: system-ui, -apple-system, sans-serif;
              max-width: 900px;
              margin: 50px auto;
              padding: 20px;
              line-height: 1.6;
              background: #0d0d0d;
              color: #e0e0e0;
            }
            h1 { color: #00a4dc; border-bottom: 2px solid #00a4dc; padding-bottom: 10px; }
            h2 { color: #00a4dc; margin-top: 30px; }
            code {
              background: #1a1a1a;
              padding: 3px 8px;
              border-radius: 4px;
              font-family: 'Courier New', monospace;
              color: #00d4ff;
            }
            pre {
              background: #1a1a1a;
              padding: 15px;
              border-radius: 8px;
              overflow-x: auto;
              border-left: 4px solid #00a4dc;
            }
            .box {
              background: #1a1a1a;
              border: 1px solid #00a4dc;
              padding: 20px;
              border-radius: 8px;
              margin: 20px 0;
            }
            .plugin-card {
              background: #1a1a1a;
              padding: 15px;
              margin: 10px 0;
              border-radius: 8px;
              border-left: 4px solid #00d4ff;
            }
            a { color: #00d4ff; text-decoration: none; }
            a:hover { text-decoration: underline; }
            button {
              padding: 12px 24px;
              background: #00a4dc;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 500;
              transition: background 0.3s;
            }
            button:hover { background: #0088b8; }
            .version { color: #888; font-size: 0.9em; }
            .badge {
              display: inline-block;
              padding: 4px 10px;
              background: #00a4dc;
              border-radius: 12px;
              font-size: 0.85em;
              margin-left: 10px;
            }
          </style>
        </head>
        <body>
          <h1>ğŸ¬ Jellyfin Plugin Repository</h1>
          <h2>Open With VLC</h2>
          
          <p>Repository de plugins pour Jellyfin - Ouvrez vos mÃ©dias directement dans VLC !</p>
          
          <div class="box">
            <h3>ğŸ“¦ URL du Repository</h3>
            <p>Ajoutez cette URL dans <strong>Jellyfin â†’ Dashboard â†’ Plugins â†’ Repositories</strong> :</p>
            <pre id="repoUrl" style="cursor: pointer;" onclick="copyUrl()"></pre>
            <button onclick="copyUrl()">ğŸ“‹ Copier l'URL</button>
          </div>
          
          <h3>ğŸ“‹ Plugins Disponibles</h3>
          <div id="pluginList">
            <p style="color: #888;">Chargement...</p>
          </div>
          
          <h3>ğŸ”— Liens Utiles</h3>
          <ul>
            <li>ğŸ“¦ <a href="https://github.com/${{ github.repository }}">GitHub Repository</a></li>
            <li>ğŸ“¥ <a href="https://github.com/${{ github.repository }}/releases">Releases</a></li>
            <li>ğŸ“„ <a href="repository/manifest.json">Manifest JSON</a></li>
            <li>ğŸ“š <a href="https://github.com/${{ github.repository }}/blob/main/README.md">Documentation</a></li>
          </ul>
          
          <hr style="margin: 40px 0; border-color: #333;">
          
          <p style="text-align: center; color: #666;">
            <small>GÃ©nÃ©rÃ© automatiquement par GitHub Actions â€¢ 
            <a href="https://github.com/${{ github.repository }}/actions">Voir les builds</a>
            </small>
          </p>
          
          <script>
            const repoUrl = window.location.origin + window.location.pathname + 'repository/manifest.json';
            document.getElementById('repoUrl').textContent = repoUrl;
            
            function copyUrl() {
              navigator.clipboard.writeText(repoUrl).then(() => {
                const btn = document.querySelector('button');
                const originalText = btn.textContent;
                btn.textContent = 'âœ… CopiÃ© !';
                setTimeout(() => btn.textContent = originalText, 2000);
              });
            }
            
            // Charger et afficher les plugins
            fetch('repository/manifest.json')
              .then(r => r.json())
              .then(data => {
                const list = document.getElementById('pluginList');
                list.innerHTML = data.map(plugin => {
                  const latestVersion = plugin.versions[0];
                  return `
                    <div class="plugin-card">
                      <h4>${plugin.name} <span class="badge">v${latestVersion.version}</span></h4>
                      <p>${plugin.description}</p>
                      <p class="version">
                        ğŸ“… ${new Date(latestVersion.timestamp).toLocaleDateString('fr-FR')} â€¢
                        ğŸ“¦ <a href="${latestVersion.artifacts[0].url}">TÃ©lÃ©charger</a>
                      </p>
                    </div>
                  `;
                }).join('');
              })
              .catch(err => {
                document.getElementById('pluginList').innerHTML = 
                  '<p style="color: #d44;">âŒ Erreur de chargement du manifest</p>';
              });
          </script>
        </body>
        </html>
        HTMLEOF
        
        echo "âœ… Site prÃ©parÃ©"
        
    - name: ğŸ“¤ Upload du site
      uses: actions/upload-pages-artifact@v3
      with:
        path: '_site'
        
    - name: ğŸš€ DÃ©ploiement sur GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    # ============================================
    # Ã‰TAPE 7 : RÃ‰SUMÃ‰
    # ============================================
    - name: âœ… RÃ©sumÃ© du dÃ©ploiement
      run: |
        echo "ğŸ‰ ============================================"
        echo "ğŸ‰ DÃ‰PLOIEMENT COMPLET RÃ‰USSI !"
        echo "ğŸ‰ ============================================"
        echo ""
        echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ” Checksum: ${{ steps.checksums.outputs.checksum }}"
        echo ""
        echo "ğŸ”— URLs disponibles:"
        echo "  â€¢ Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
        echo "  â€¢ Site: ${{ steps.deployment.outputs.page_url }}"
        echo "  â€¢ Manifest: ${{ steps.deployment.outputs.page_url }}repository/manifest.json"
        echo ""
        echo "âœ… Le plugin est maintenant installable via Jellyfin !"

