name: ğŸš€ Auto Release Complete

# Ce workflow fait TOUT automatiquement :
# 1. Build du plugin
# 2. CrÃ©ation de la release GitHub
# 3. Mise Ã  jour du manifest.json
# 4. DÃ©ploiement sur GitHub Pages

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (ex: 1.1.0)'
        required: false

permissions:
  contents: write
  pages: write
  id-token: write
  deployments: write

jobs:
  complete-release:
    runs-on: ubuntu-latest
    
    steps:
    # ============================================
    # Ã‰TAPE 1 : CHECKOUT & VALIDATION
    # ============================================
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0
      
    - name: ğŸ“‹ DÃ©tection de la version
      id: version
      run: |
        if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_type }}" == "tag" ]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        elif [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=$(jq -r '.Version' plugin.json)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version dÃ©tectÃ©e: $VERSION"
        
    - name: ğŸ” Validation
      run: |
        echo "Validation des fichiers..."
        jq empty plugin.json || { echo "âŒ plugin.json invalide"; exit 1; }
        jq empty repository/manifest.json || { echo "âŒ manifest.json invalide"; exit 1; }
        node -c web/js/vlcMenu.js || { echo "âŒ vlcMenu.js invalide"; exit 1; }
        echo "âœ… Tous les fichiers sont valides"
    
    # ============================================
    # Ã‰TAPE 2 : BUILD DE LA DLL C# (.NET)
    # ============================================
    - name: ğŸ”§ Build de la DLL C# avec Docker
      run: |
        chmod +x build-dotnet.sh
        ./build-dotnet.sh
        echo "âœ… DLL .NET buildÃ©e"
        
    # ============================================
    # Ã‰TAPE 3 : BUILD DU PACKAGE COMPLET
    # ============================================
    - name: ğŸ“¦ Build du package ZIP (avec DLL)
      run: |
        chmod +x build.sh
        ./build.sh
        echo "ğŸ“¦ Build terminÃ©"
        ls -lh dist/
        echo ""
        echo "ğŸ“‹ Contenu du ZIP:"
        unzip -l dist/Jellyfin-OpenWithVLC-v${{ steps.version.outputs.version }}.zip
        
    - name: ğŸ” Calcul des checksums
      id: checksums
      run: |
        ZIP_CHECKSUM=$(sha256sum dist/Jellyfin-OpenWithVLC-v${{ steps.version.outputs.version }}.zip | cut -d' ' -f1)
        echo "checksum=$ZIP_CHECKSUM" >> $GITHUB_OUTPUT
        echo "ğŸ” SHA256: $ZIP_CHECKSUM"
    
    # ============================================
    # Ã‰TAPE 4 : CALCUL DES CHECKSUMS
    # ============================================
    - name: ğŸ“ Extraction du changelog
      id: changelog
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        
        if [ -f CHANGELOG.md ]; then
          # Extraire la section du changelog
          NOTES=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' | sed '/^$/d' || echo "")
          
          if [ -z "$NOTES" ]; then
            NOTES="Version $VERSION - Voir CHANGELOG.md pour les dÃ©tails"
          fi
        else
          NOTES="Version $VERSION"
        fi
        
        # Sauvegarder dans un fichier pour Ã©viter les problÃ¨mes de multiline
        echo "$NOTES" > /tmp/release_notes.txt
        echo "ğŸ“ Changelog extrait"
    
    # ============================================
    # Ã‰TAPE 5 : EXTRACTION DU CHANGELOG
    # ============================================
    - name: ğŸš€ CrÃ©ation de la release GitHub
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: v${{ steps.version.outputs.version }}
        body_path: /tmp/release_notes.txt
        files: |
          dist/*.zip
          dist/*.sha256
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ============================================
    # Ã‰TAPE 6 : CRÃ‰ATION DE LA RELEASE GITHUB
    # ============================================
    - name: ğŸ“ Mise Ã  jour du manifest.json
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        CHECKSUM="${{ steps.checksums.outputs.checksum }}"
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        echo "Mise Ã  jour du manifest avec:"
        echo "  Version: $VERSION"
        echo "  Checksum: $CHECKSUM"
        echo "  Timestamp: $TIMESTAMP"
        
        # Extraire le changelog pour cette version
        if [ -f CHANGELOG.md ]; then
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '1d;$d' | grep '^-' | sed 's/^- //' | tr '\n' '\\n' || echo "Version $VERSION")
        else
          CHANGELOG="Version $VERSION"
        fi
        
        # Mettre Ã  jour le manifest
        cd repository
        
        jq --arg version "$VERSION" \
           --arg checksum "$CHECKSUM" \
           --arg timestamp "$TIMESTAMP" \
           --arg changelog "$CHANGELOG" \
           --arg url "https://github.com/${{ github.repository }}/releases/download/v$VERSION/Jellyfin-OpenWithVLC-v$VERSION.zip" \
           --arg sourceUrl "https://github.com/${{ github.repository }}/archive/refs/tags/v$VERSION.tar.gz" \
           '.[0].versions = [
              {
                "version": $version,
                "changelog": $changelog,
                "targetAbi": "10.11.1.0",
                "sourceUrl": $sourceUrl,
                "checksum": $checksum,
                "timestamp": $timestamp,
                "artifacts": [
                  {
                    "filename": ("Jellyfin-OpenWithVLC-v" + $version + ".zip"),
                    "url": $url,
                    "checksum": $checksum
                  }
                ]
              }
            ] + (.[0].versions // [])' manifest.json > manifest.json.tmp
        
        mv manifest.json.tmp manifest.json
        
        echo "âœ… Manifest mis Ã  jour"
        jq '.[0].versions[0]' manifest.json
        
    - name: ğŸ“¤ Commit et push du manifest mis Ã  jour
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # S'assurer d'Ãªtre sur la branche main
        git checkout main
        git pull origin main
        
        git add repository/manifest.json
        
        if git diff --staged --quiet; then
          echo "Aucun changement dans le manifest"
        else
          git commit -m "chore: auto-update manifest for v${{ steps.version.outputs.version }}"
          git push origin main
          echo "âœ… Manifest poussÃ© - GitHub Pages se mettra Ã  jour automatiquement"
        fi
    
    # ============================================
    # Ã‰TAPE 7 : MISE Ã€ JOUR DU MANIFEST.JSON
    # ============================================
    - name: â„¹ï¸ Note sur GitHub Pages
      run: |
        echo "â„¹ï¸ Le manifest a Ã©tÃ© mis Ã  jour et poussÃ©."
        echo "â„¹ï¸ GitHub Pages se mettra Ã  jour automatiquement via le workflow sÃ©parÃ©."
        echo "â„¹ï¸ Cela peut prendre 1-2 minutes supplÃ©mentaires."
    
    # ============================================
    # Ã‰TAPE 8 : RÃ‰SUMÃ‰
    # ============================================
    - name: âœ… RÃ©sumÃ© du dÃ©ploiement
      run: |
        echo "ğŸ‰ ============================================"
        echo "ğŸ‰ DÃ‰PLOIEMENT COMPLET RÃ‰USSI !"
        echo "ğŸ‰ ============================================"
        echo ""
        echo "ğŸ“¦ Version: ${{ steps.version.outputs.version }}"
        echo "ğŸ” Checksum: ${{ steps.checksums.outputs.checksum }}"
        echo ""
        echo "ğŸ”— URLs disponibles:"
        echo "  â€¢ Release: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"
        echo "  â€¢ Site: https://j4n0kun.github.io/Jellyfin-OpenWithVLC/"
        echo "  â€¢ Manifest: https://j4n0kun.github.io/Jellyfin-OpenWithVLC/repository/manifest.json"
        echo ""
        echo "âœ… Le plugin est maintenant installable via Jellyfin !"

